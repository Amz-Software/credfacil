{% extends 'base.html' %}
{% load static iam_tags %}
{% block title %}
  {% if cliente.pk %}Editar Cliente{% else %}Criar Cliente{% endif %}
{% endblock title %}

{% block content %}
{% load l10n %}
<div class="container-xxl mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card">
        {# Header com título, badge de status e botões #}
        <div class="card-header d-flex justify-content-between align-items-center p-3">
            <div class="d-flex align-items-center">
                <h4 class="card-title mb-0 me-3 fs-5 fw-semibold">
                  {% if cliente.pk %}Editar Cliente{% else %}Criar Cliente{% endif %}
                </h4>
                {% if cliente.pk and cliente.analises_credito.exists %}
                  {% with analise=cliente.analises_credito.first %}
                    <span class="badge px-4 py-2 fs-6 text-uppercase shadow-sm
                      {% if analise.status == 'A' %}bg-success text-white
                      {% elif analise.status == 'R' %}bg-danger text-white
                      {% elif analise.status == 'C' %}bg-secondary text-white                        
                      {% else %}bg-warning text-dark{% endif %}">
                      {{ analise.get_status_display }}
                    </span>
                  {% endwith %}
                {% endif %}
              </div>
              

          {% if cliente.pk and cliente.analises_credito.exists %}
            {% with analise=cliente.analises_credito.first %}
            <div>
                {% if user|has_perm:'vendas.change_status_analise' and analise.status != 'A' %}
                  <a href="{% url 'vendas:aprovar_analise' analise.id %}"
                     class="btn btn-sm btn-outline-success me-2">
                    Aprovar
                  </a>
                  {% endif %}
                  <a href="{% url 'vendas:reprovar_analise' analise.id %}"
                     class="btn btn-sm btn-outline-danger me-2">
                    Reprovar
                  </a>
                  <a href="{% url 'vendas:cancelar_analise' analise.id %}"
                     class="btn btn-sm btn-outline-secondary">
                    Cancelar
                  </a>
                </div>
            {% endwith %}
          {% endif %}
        </div>

        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {% if cliente_id %}
              <input type="hidden" name="cliente_id" value="{{ cliente_id }}">
            {% endif %}

            <h3>Dados Cliente</h3>
            <hr>
            <div class="row">
              {% for field in form_cliente %}
                {% if field.label == 'Cliente cred facil' %}
                  <div class="col-md-12">
                    <div class="form-check form-switch mt-3">
                      {{ field }}
                      <label class="form-check-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                    </div>
                  </div>
                {% elif field.label == 'Nascimento' %}
                  <div class="col-md-6">
                    <div class="form-group mt-3">
                      <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                      <input type="date" class="form-control"
                             id="{{ field.id_for_label }}"
                             name="{{ field.name }}"
                             value="{{ field.value|date:"Y-m-d" }}">
                    </div>
                  </div>
                {% else %}
                  <div class="col-md-6">
                    <div class="form-group mt-3">
                      <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                      {{ field }}
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            </div>

            <h3 class="mt-3">Informações Adicionais</h3>
            <hr>
            <div class="row">
              {% for field in form_adicional %}
                <div class="col-md-6">
                  <div class="form-group mt-3">
                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                    {{ field }}
                  </div>
                </div>
              {% endfor %}
            </div>

            <h3 class="mt-3">Comprovantes</h3>
            <hr>
            <div class="row">
              {% for field in form_comprovantes %}
                <div class="col-md-6">
                  <div class="form-group mt-3">
                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                    {% if field.value %}
                      <a href="{{ field.value.url }}" target="_blank" class="d-block mt-2">
                        <img src="{{ field.value.url }}" class="img-thumbnail" style="max-height: 100px;">
                      </a>
                      <span>Deseja trocar o arquivo? Escolha um novo e clique em salvar.</span>
                    {% endif %}
                    {{ field }}
                  </div>
                </div>
              {% endfor %}
            </div>

            <h3 class="mt-3">Análise de Crédito</h3>
            <hr>
            <div class="row">
              {% for field in form_analise_credito %}
                <div class="col-md-12">
                  <div class="form-group mt-3">
                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                    {{ field }}
                  </div>
                </div>
              {% endfor %}
            </div>

            {% if user|has_perm:"vendas.change_cliente" %}
              <button type="submit" class="btn btn-primary mt-3">Salvar</button>
            {% endif %}
            <a href="{% url 'vendas:cliente_list' %}" class="btn btn-secondary mt-3">Voltar</a>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
