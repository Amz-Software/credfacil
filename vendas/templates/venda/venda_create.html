{% extends "base.html" %}
{% load  iam_tags %}
{% block title %}
Criar Venda
{% endblock title %}

{% block content %}

<div class="container-xxl mt-4">
  <div class="row">
    <div class="col-12">
    <div class="card">
        <div class="container-xxl flex-grow-1 container-p-y">
            <h4 class="py-3 mb-4"><span class="text-muted fw-light">Venda/</span> Criar</h4>
            <div class="row">
              <div class="col-xl">
                <div class="card mb-4">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Criar Venda</h5>
                  </div>
                  <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <!-- <h3>Dados</h3> -->
                        <hr>

                        <div class="row g-3">
                          <div class="col-md-6">
                            <label for="id_cliente" class="form-label">Cliente</label>
                            {{ form.cliente }}
                          </div>
                          <div class="col-md-6">
                            <label for="id_vendedor" class="form-label">Vendedor</label>
                            {{ form.vendedor }}
                          </div>
                          <div class="col-md-6">
                            <label for="id_tipo_venda" class="form-label">Tipo de Venda</label>
                            {{ form.tipo_venda }}
                          </div>
                          <div class="col-md-6">
                            <label for="id_tipo_entrega" class="form-label">Tipo de Entrega</label>
                            {{ form.tipo_entrega }}
                          </div>
                          <div class="col-md-12">
                            <label for="id_observacao" class="form-label">observacao</label>
                            {{ form.observacao }}
                          </div>

                        </div>
                        
                        <h3 class="mt-4">Produtos</h3>
                        <hr>
                        {{ produto_venda_formset.management_form }}
                        <div id="produto-empty-form" style="display: none;">
                          <div class="produto-form-template">
                            <hr>
                            {{ produto_venda_formset.empty_form}}
                          </div>
                        </div>
                        <div id="produtos" class="mb-3">
                        {% for form in produto_venda_formset %}
                          <div class="produto-form">
                            {{ form }}
                            <button type="button" class="btn btn-danger btn-sm remove-produto mt-3" onclick="removerProduto(this)">Remover</button>
                          </div>
                        {% endfor %}
                      </div>
                      <div class="acao mb-3">
                        <button type="button" id="add-produto" class="btn btn-primary" onclick="adicionarProduto()">Adicionar Produto</button>
                      </div>
                        
                        <h3>Pagamentos</h3>
                        <hr>
                        {{ pagamento_formset.management_form }}
                        <div id="pagamento-empty-form" style="display: none;">
                          <div class="pagamento-form-template">
                            <hr>
                            {{ pagamento_formset.empty_form}}
                          </div>
                        </div>
                        <div id="pagamentos" class="mb-3">
                        {% for form in pagamento_formset %}
                          <div class="pagamento-form">
                            {{ form }}
                            <button type="button" class="btn btn-danger btn-sm remove-pagamento mt-3" onclick="removerPagamento(this)">Remover</button>
                          </div>
                        {% endfor %}
                      </div>
                      <div class="acao mb-3">
                        <button type="button" id="add-pagamento" class="btn btn-primary" onclick="adicionarPagamento()">Adicionar Pagamento</button>
                      </div>
                        
                      <hr>
                      <button type="submit" class="btn btn-primary">Criar Venda</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
    </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>

  document.addEventListener('DOMContentLoaded', function () {
    function configurarProdutoForm(form) {
        const produtoSelect = form.querySelector('select[name$="-produto"]');
        const imeiField = form.querySelector('input[name$="-imei"]');
        const valorField = form.querySelector('input[name$="-valor_unitario"]');
        const quantidadeField = form.querySelector('input[name$="-quantidade"]');
        const valorTotalField = form.querySelector('input[name$="-valor_total"]');
        const valorDescontoField = form.querySelector('input[name$="-valor_desconto"]');
        valorDescontoField.value = "0.00";
        valorField.value = "";
        quantidadeField.value = "";
        valorTotalField.value = "";
        imeiField.value = "";
        imeiField.disabled = true;
        imeiField.required = false;
        quantidadeField.disabled = true;

        // Função para atualizar o valor total
        function atualizarValorTotal() {
            const valorUnitario = parseFloat(valorField.value) || 0;
            const quantidade = parseInt(quantidadeField.value) || 0;
            const valorDesconto = parseFloat(valorDescontoField.value) || 0;

            const valorTotal = (valorUnitario * quantidade) - valorDesconto;
            valorTotalField.value = valorTotal.toFixed(2); // Exibe com 2 casas decimais
        }

        // Inicializa o valor total
        valorTotalField.value = "0.00";

        if (!produtoSelect || !imeiField || !valorField) return;

        produtoSelect.addEventListener('change', function () {
            const produtoId = this.value;
            const formPrefix = this.name.match(/(.+?)-produto/)[1];
            
            if (!produtoId) {
                valorField.value = "";
                quantidadeField.value = "";
                valorTotalField.value = "";
                imeiField.value = "";
                imeiField.disabled = true;
                imeiField.required = false;
                quantidadeField.disabled = true;
                return;
            }

            fetch(`/produto/details/${produtoId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.serializado) {
                        // Produto serializado: Habilitar o campo IMEI
                        imeiField.disabled = false;
                        imeiField.value = "";
                        imeiField.required = true;
                        quantidadeField.value = 1;  // Fixar quantidade para 1
                        quantidadeField.disabled = false;  // Permitir interação com quantidade
                        
                        
                        valorField.value = "";
                        
                        imeiField.addEventListener('blur', function () {
                          if (imeiField.value) {
                            fetch(`/info-products/?product_id=${produtoId}&imei=${imeiField.value}`)
                            .then(response => response.json())
                            .then(info => {
                              if (info.status === "success") {
                                    // Verificar tentativas de alteração da quantidade
                                    quantidadeField.addEventListener('input', function () {
                                        if (quantidadeField.value !== "1") {
                                            alert("Produto serializado, a quantidade deve ser 1.");
                                            quantidadeField.value = 1; // Resetar para 1
                                        }
                                    });
                                    valorField.value = info.price;
                                    atualizarValorTotal(); // Atualiza o valor total quando o preço é alterado
                                        } else {
                                            alert(info.message);
                                            valorField.value = "";
                                            imeiField.value = "";
                                        }
                                    });
                            }
                        });
                    } else {
                        // Produto não serializado: Desabilitar o campo IMEI
                        imeiField.disabled = true;
                        imeiField.value = "";
                        imeiField.required = false;
                        quantidadeField.disabled = false;

                        // Buscar preço diretamente
                        fetch(`/info-products/?product_id=${produtoId}`)
                            .then(response => response.json())
                            .then(info => {
                                if (info.status === "success") {
                                    valorField.value = info.price;
                                    atualizarValorTotal(); // Atualiza o valor total quando o preço é alterado
                                } else {
                                    alert(info.message);
                                    valorField.value = "";
                                }
                            });
                    }
                });
        });

        // Adicionar event listeners para atualizar o valor total
        valorField.addEventListener('input', atualizarValorTotal);
        quantidadeField.addEventListener('input', atualizarValorTotal);
        valorDescontoField.addEventListener('input', atualizarValorTotal);
    }

    // Configurar formulários existentes ao carregar a página
    document.querySelectorAll('.produto-form').forEach(configurarProdutoForm);

    function adicionarProduto() {
        const emptyForm = document.querySelector("#produto-empty-form .produto-form-template");
        let newForm = emptyForm.cloneNode(true);
    
        newForm.classList.remove('produto-form-template');
        newForm.classList.add('produto-form');
    
        const produtoForms = document.querySelectorAll(".produto-form");
        let totalForms = document.getElementById("id_itens_venda-TOTAL_FORMS");
        let formIndex = produtoForms.length;
    
        newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, formIndex);
    
        // Limpar os valores dos campos clonados
        let formInputs = newForm.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            input.value = '';
        });
    
        totalForms.value = formIndex + 1;
    
        // Adicionar botão de remover
        const removeButton = document.createElement('button');
        removeButton.type = "button";
        removeButton.classList.add("btn", "btn-danger", "btn-sm", "remove-produto", 'mt-3');
        removeButton.textContent = "Remover";
        removeButton.onclick = () => removerProduto(removeButton);
        newForm.appendChild(removeButton);
    
        const produtosContainer = document.getElementById("produtos");
        produtosContainer.appendChild(newForm);
        newForm.style.display = ''; // Certifique-se de que o formulário está visível
    
        // Configurar o novo formulário
        configurarProdutoForm(newForm);
    }

    function removerProduto(button) {
        const produtoForm = button.closest('.produto-form');
        produtoForm.remove();

        // Atualizar TOTAL_FORMS
        const totalForms = document.getElementById("id_itens_venda-TOTAL_FORMS");
        totalForms.value = document.querySelectorAll(".produto-form").length;
    }

    // Substituir o botão para adicionar produtos
    document.getElementById('add-produto').onclick = adicionarProduto;
});


</script>
<script>
  function adicionarPagamento() {
    const emptyForm = document.querySelector("#pagamento-empty-form .pagamento-form-template");
    let newForm = emptyForm.cloneNode(true);
  
    newForm.classList.remove('pagamento-form-template');
    newForm.classList.add('pagamento-form');
  
    const pagamentoForms = document.querySelectorAll(".pagamento-form");
    let totalForms = document.getElementById("id_pagamentos-TOTAL_FORMS");
    let formIndex = pagamentoForms.length;
  
    newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, formIndex);
  
    // Limpar os valores dos campos clonados
    let formInputs = newForm.querySelectorAll('input, select, textarea');
    formInputs.forEach(input => {
        input.value = '';
    });
  
    totalForms.value = formIndex + 1;

    // Adicionar botão de remover
    const removeButton = document.createElement('button');
    removeButton.type = "button";
    removeButton.classList.add("btn", "btn-danger", "btn-sm", "remove-pagamento", 'mt-3');
    removeButton.textContent = "Remover";
    removeButton.onclick = () => removerPagamento(removeButton);
    newForm.appendChild(removeButton);

    document.getElementById("pagamentos").appendChild(newForm);
    newForm.style.display = '';  // Certifique-se de que o formulário está visível

    // Configurar listener para o tipo de pagamento e cálculo dinâmico
    configurarPagamentoForm(newForm);
  }

  function removerPagamento(button) {
    const pagamentoForm = button.closest('.pagamento-form');
    pagamentoForm.remove();

    // Atualizar TOTAL_FORMS
    const totalForms = document.getElementById("id_pagamentos-TOTAL_FORMS");
    totalForms.value = document.querySelectorAll(".pagamento-form").length;
  }

  function configurarPagamentoForm(form) {
    const tipoPagamentoSelect = form.querySelector('select[name$="-tipo_pagamento"]');
    const parcelasField = form.querySelector('input[name$="-parcelas"]');
    const valorField = form.querySelector('input[name$="-valor"]');
    const valorParcelaField = form.querySelector('input[name$="-valor_parcela"]');

    if (!tipoPagamentoSelect || !parcelasField || !valorField || !valorParcelaField) return;

    // Função para verificar e configurar parcelas com base no tipo de pagamento
    function atualizarParcelas() {
      const paymentId = tipoPagamentoSelect.value;

      if (!paymentId) {
        parcelasField.disabled = true; // Desabilitar o campo
        parcelasField.value = 1; // Resetar o valor para o padrão
        atualizarValorParcela(); // Atualizar valor_parcela
        return;
      }

      // Buscar informações sobre o tipo de pagamento
      fetch(`/info-payment/?payment_id=${paymentId}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === "success") {
            if (data.parcela) {
              parcelasField.disabled = false; // Ativar o campo
              parcelasField.value = parcelasField.value || 1; // Valor inicial padrão
            } else {
              parcelasField.disabled = true; // Desativar o campo
              parcelasField.value = 1; // Resetar para o padrão
            }
            atualizarValorParcela(); // Atualizar valor_parcela
          } else {
            alert("Erro ao buscar informações do tipo de pagamento.");
          }
        })
        .catch(err => {
          console.error("Erro ao buscar informações de pagamento:", err);
        });
    }

    // Função para atualizar o campo valor_parcela
    function atualizarValorParcela() {
      const valor = parseFloat(valorField.value) || 0;
      const parcelas = parseInt(parcelasField.value) || 1;

      valorParcelaField.value = (valor / parcelas).toFixed(2); // Atualizar o valor_parcela
    }

    // Adicionar eventos para recalcular o valor_parcela
    parcelasField.addEventListener('input', atualizarValorParcela);
    valorField.addEventListener('input', atualizarValorParcela);

    // Adicionar evento de change ao select de tipo de pagamento
    tipoPagamentoSelect.addEventListener('change', atualizarParcelas);

    // Atualizar parcelas e valor_parcela ao carregar o formulário
    atualizarParcelas();
  }

  // Configurar formulários existentes ao carregar a página
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.pagamento-form').forEach(configurarPagamentoForm);
  });

</script>


{% endblock %}
